{
  "name": "OpenHands-to-GitLab",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "openhands-to-gitlab",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "openhands-to-gitlab-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Determine if this issue should go to community or release GitLab\nconst issue = $input.item.json;\nconst mapping = $getNodeParameter('mapping.gitlab');\n\n// Check for release indicators in labels or description\nconst isRelease = issue.labels?.some(label => \n  ['release', 'publish', 'deployment'].includes(label.toLowerCase())\n) || \n  issue.description?.toLowerCase().includes('#release') ||\n  issue.description?.toLowerCase().includes('#publish');\n\n// Set target GitLab location\nif (isRelease) {\n  // Use release GitLab\n  return [{\n    json: {\n      ...issue,\n      gitlab_target: 'release',\n      gitlab_group: mapping.release.group,\n      // Select a project based on issue content or labels\n      gitlab_project: selectProject(issue, mapping.release.projects)\n    }\n  }];\n} else {\n  // Use community GitLab\n  return [{\n    json: {\n      ...issue,\n      gitlab_target: 'community',\n      gitlab_group: mapping.community.group,\n      // Select a project based on issue content or labels\n      gitlab_project: selectProject(issue, mapping.community.projects)\n    }\n  }];\n}\n\n// Helper function to select the most appropriate project\nfunction selectProject(issue, projects) {\n  // Simple implementation - can be enhanced with more sophisticated matching\n  for (const label of (issue.labels || [])) {\n    for (const project of projects) {\n      if (label.toLowerCase().includes(project.toLowerCase())) {\n        return project;\n      }\n    }\n  }\n  \n  // Default to first project if no match found\n  return projects[0];\n}"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300],
      "id": "route-to-gitlab-target"
    },
    {
      "parameters": {
        "authentication": "accessToken",
        "resource": "issue",
        "operation": "create",
        "projectId": "={{ $json.gitlab_group + '/' + $json.gitlab_project }}",
        "title": "={{ $json.title }}",
        "description": "={{ $json.description + '\\n\\nSource: OpenHands\\nInstance: ' + $json.instance_name + '\\nOriginal URL: ' + $json.url }}",
        "additionalFields": {
          "labels": "={{ $json.labels ? $json.labels.join(',') : '' }}"
        }
      },
      "type": "n8n-nodes-base.gitlab",
      "typeVersion": 1,
      "position": [680, 300],
      "id": "create-gitlab-issue"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "List Work Packages",
        "filters": {
          "fields": [
            {
              "name": "customField1",
              "value": "openhands"
            },
            {
              "name": "customField2",
              "value": "={{ $json.source_id }}"
            },
            {
              "name": "customField3",
              "value": "={{ $json.instance_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [680, 500],
      "id": "find-openproject-workpackage"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": ""parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json._embedded ? $json._embedded.elements.length : 0 }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 500],
      "id": "check-openproject-exists"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "Update Work Package",
        "id": "={{ $json._embedded.elements[0].id }}",
        "description": "={{ $json._embedded.elements[0].description.raw + '\\n\\nLinked to GitLab issue: ' + $json.gitlab_target + '/' + $json.gitlab_group + '/' + $json.gitlab_project + '/issues/' + $json.iid }}",
        "additionalFields": {
          "customField4": "={{ $json.gitlab_target }}",
          "customField5": "={{ $json.gitlab_project }}",
          "customField6": "={{ $json.iid }}"
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [1120, 400],
      "id": "update-openproject-with-gitlab"
    },
    {
      "parameters": {
        "url": "={{ $json.instance_url }}/api/issues/{{ $json.source_id }}/link",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "httpHeaderAuth": {
          "name": "Authorization",
          "value": "=Bearer {{ $getNodeParameter('instances').find(i => i.id === $json.instance_id).apiKey }}"
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"link_type\": \"gitlab_issue\",\n  \"url\": \"https://gitlab.com/\" + $json.gitlab_group + \"/\" + $json.gitlab_project + \"/issues/\" + $json.iid,\n  \"title\": \"GitLab Issue #\" + $json.iid,\n  \"description\": \"Linked to GitLab issue in the \" + $json.gitlab_target + \" project\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [900, 300],
      "id": "update-openhands-with-gitlab-link"
    }
  ],
  "connections": {
    "openhands-to-gitlab-webhook": {
      "main": [
        [
          {
            "node": "route-to-gitlab-target",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "route-to-gitlab-target": {
      "main": [
        [
          {
            "node": "create-gitlab-issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create-gitlab-issue": {
      "main": [
        [
          {
            "node": "update-openhands-with-gitlab-link",
            "type": "main",
            "index": 0
          },
          {
            "node": "find-openproject-workpackage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find-openproject-workpackage": {
      "main": [
        [
          {
            "node": "check-openproject-exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-openproject-exists": {
      "main": [
        [
          {
            "node": "update-openproject-with-gitlab",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveManualExecutions": true
  }
}
