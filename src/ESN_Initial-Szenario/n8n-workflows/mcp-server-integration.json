{
  "name": "MCP-Server-Integration",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mcp-to-openproject",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "mcp-to-openproject-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.llm_analyzed }}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300],
      "id": "check-if-analyzed"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "List Work Packages",
        "filters": {
          "fields": [
            {
              "name": "customField1",
              "value": "mcp_server"
            },
            {
              "name": "customField2",
              "value": "={{ $json.source_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [680, 200],
      "id": "find-existing-work-package"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json._embedded ? $json._embedded.elements.length : 0 }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 400],
      "id": "check-work-package-exists"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "Update Work Package",
        "id": "={{ $json._embedded.elements[0].id }}",
        "subject": "={{ $json.title }}",
        "description": "={{ $json._embedded.elements[0].description.raw + '\\n\\nUpdate from MCP Server (' + $json.server_name + '): ' + $json.description }}",
        "_links": {
          "status": {
            "href": "={{ '/api/v3/statuses/' + ($json.severity === 'critical' ? '7' : '1') }}"
          }
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [900, 300],
      "id": "update-work-package"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "Create Work Package",
        "subject": "={{ $json.title }}",
        "description": "={{ $json.description + '\\n\\nSource: MCP Server (' + $json.server_name + ')\\nType: ' + $json.type + '\\nSeverity: ' + $json.severity + '\\nTimestamp: ' + $json.timestamp + '\\nComponents: ' + $json.components.join(', ') }}",
        "_links": {
          "project": {
            "href": "/api/v3/projects/1"
          },
          "type": {
            "href": "/api/v3/types/1"
          },
          "status": {
            "href": "={{ '/api/v3/statuses/' + ($json.severity === 'critical' ? '7' : '1') }}"
          },
          "priority": {
            "href": "={{ '/api/v3/priorities/' + ($json.severity === 'critical' ? '7' : $json.severity === 'error' ? '6' : $json.severity === 'warning' ? '5' : '3') }}"
          }
        },
        "additionalFields": {
          "customField1": "mcp_server",
          "customField2": "={{ $json.source_id }}",
          "customField3": "={{ $json.server_name }}"
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [900, 500],
      "id": "create-work-package"
    },
    {
      "parameters": {
        "operation": "upsert",
        "databaseId": "={{ $env.APPFLOWY_DATABASE_ID }}",
        "record": "={\n  \"Title\": $json.title,\n  \"Description\": $json.description,\n  \"Source\": \"mcp_server\",\n  \"Server\": $json.server_name,\n  \"Source ID\": $json.source_id,\n  \"Type\": $json.type,\n  \"Severity\": $json.severity,\n  \"Components\": $json.components ? $json.components.join(\", \") : \"\",\n  \"Timestamp\": $json.timestamp,\n  \"OpenProject ID\": $json.id,\n  \"Last Updated\": new Date().toISOString()\n}"
      },
      "type": "n8n-nodes-base.appflowy",
      "typeVersion": 1,
      "position": [1120, 400],
      "id": "update-appflowy-record"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=http://localhost:5678/webhook/llm-analyze",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [460, 500],
      "id": "send-to-llm-agent"
    }
  ],
  "connections": {
    "mcp-to-openproject-webhook": {
      "main": [
        [
          {
            "node": "check-if-analyzed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-if-analyzed": {
      "main": [
        [
          {
            "node": "find-existing-work-package",
            "type": "main",
            "index": 0
          }
        ],
