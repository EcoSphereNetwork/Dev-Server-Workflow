{
  "name": "GitLab-to-OpenProject",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gitlab-to-openproject",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "gitlab-to-openproject-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.llm_analyzed }}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300],
      "id": "check-if-analyzed"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "List Work Packages",
        "filters": {
          "fields": [
            {
              "name": "customField1",
              "value": "gitlab"
            },
            {
              "name": "customField2",
              "value": "={{ $json.source_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [680, 200],
      "id": "find-existing-work-package"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json._embedded ? $json._embedded.elements.length : 0 }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 400],
      "id": "check-work-package-exists"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "Update Work Package",
        "id": "={{ $json._embedded.elements[0].id }}",
        "subject": "={{ $json.title }}",
        "description": "={{ $json._embedded.elements[0].description.raw + '\\n\\nUpdate from GitLab: ' + $json.description + '\\n\\nURL: ' + $json.url }}",
        "_links": {
          "status": {
            "href": "={{ '/api/v3/statuses/' + ($json.status === 'closed' ? '7' : '1') }}"
          }
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [900, 300],
      "id": "update-work-package"
    },
    {
      "parameters": {
        "resource": "Work Packages",
        "operation": "Create Work Package",
        "subject": "={{ $json.title }}",
        "description": "={{ $json.description + '\\n\\nSource: GitLab\\nURL: ' + $json.url + '\\nCreator: ' + $json.creator + '\\nRepository: ' + $json.repository }}",
        "_links": {
          "project": {
            "href": "/api/v3/projects/1"
          },
          "type": {
            "href": "={{ $json.category ? ('/api/v3/types/' + ($json.category === 'bug' ? '1' : $json.category === 'feature' ? '2' : '3')) : '/api/v3/types/1' }}"
          },
          "status": {
            "href": "={{ '/api/v3/statuses/' + ($json.status === 'closed' ? '7' : '1') }}"
          },
          "priority": {
            "href": "={{ $json.priority ? ('/api/v3/priorities/' + ($json.priority === 'high' ? '7' : $json.priority === 'medium' ? '5' : '3')) : '/api/v3/priorities/5' }}"
          }
        },
        "additionalFields": {
          "customField1": "gitlab",
          "customField2": "={{ $json.source_id }}"
        }
      },
      "type": "n8n-nodes-base.openProject",
      "typeVersion": 1,
      "position": [900, 500],
      "id": "create-work-package"
    },
    {
      "parameters": {
        "operation": "upsert",
        "databaseId": "={{ $env.APPFLOWY_DATABASE_ID }}",
        "record": "={\n  \"Title\": $json.title,\n  \"Description\": $json.description,\n  \"Source\": \"gitlab\",\n  \"Source ID\": $json.source_id,\n  \"URL\": $json.url,\n  \"Status\": $json.status,\n  \"Creator\": $json.creator,\n  \"OpenProject ID\": $json.id,\n  \"Category\": $json.category || \"unspecified\",\n  \"Priority\": $json.priority || \"medium\",\n  \"Components\": $json.components ? $json.components.join(\", \") : \"\",\n  \"Last Updated\": new Date().toISOString()\n}"
      },
      "type": "n8n-nodes-base.appflowy",
      "typeVersion": 1,
      "position": [1120, 400],
      "id": "update-appflowy-record"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=http://localhost:5678/webhook/llm-analyze",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [460, 500],
      "id": "send-to-llm-agent"
    }
  ],
  "connections": {
    "gitlab-to-openproject-webhook": {
      "main": [
        [
          {
            "node": "check-if-analyzed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-if-analyzed": {
      "main": [
        [
          {
            "node": "find-existing-work-package",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send-to-llm-agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find-existing-work-package": {
      "main": [
        [
          {
            "node": "check-work-package-exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-work-package-exists": {
      "main": [
        [
          {
            "node": "update-work-package",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "create-work-package",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update-work-package": {
      "main": [
        [
          {
            "node": "update-appflowy-record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create-work-package": {
      "main": [
        [
          {
            "node": "update-appflowy-record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send-to-llm-agent": {
      "main": [
        [
          {
            "node": "find-existing-work-package",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveManualExecutions": true
  }
}
